<%# views/layout/master/ejs %>
  <!DOCTYPE html>
  <html lang="en" class="light-style layout-menu-fixed" dir="ltr" data-theme="theme-default"
    data-assets-path="/admin/assets/" data-template="vertical-menu-template-free">

  <head>
    <meta charset="utf-8" />
    <meta name="viewport"
      content="width=device-width, initial-scale=1.0, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0" />

    <title>
      <%= title %>
    </title>

    <meta name="description" content="" />

    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="/admin/assets/img/favicon/favicon.ico" />

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Public+Sans:ital,wght@0,300;0,400;0,500;0,600;0,700;1,300;1,400;1,500;1,600;1,700&display=swap"
      rel="stylesheet" />

    <!-- Icons. Uncomment required icon fonts -->
    <link rel="stylesheet" href="/admin/assets/vendor/fonts/boxicons.css" />

    <!-- Core CSS -->
    <link rel="stylesheet" href="/admin/assets/vendor/css/core.css" class="template-customizer-core-css" />
    <link rel="stylesheet" href="/admin/assets/vendor/css/theme-default.css" class="template-customizer-theme-css" />
    <link rel="stylesheet" href="/admin/assets/css/demo.css" />

    <!-- Vendors CSS -->
    <link rel="stylesheet" href="/admin/assets/vendor/libs/perfect-scrollbar/perfect-scrollbar.css" />

    <link rel="stylesheet" href="/admin/assets/vendor/libs/apex-charts/apex-charts.css" />

    <!-- Page CSS -->

    <!-- Helpers -->
    <script src="/admin/assets/vendor/js/helpers.js"></script>

    <!--! Template customizer & Theme config files MUST be included after core stylesheets and helpers.js in the <head> section -->
    <!--? Config:  Mandatory theme config file contain global vars & default theme options, Set your preferred theme option in this file.  -->
    <script src="/admin/assets/js/config.js"></script>
  </head>

  <body>
    <!-- Layout wrapper -->
    <div class="layout-wrapper layout-content-navbar">
      <div class="layout-container">
        <!-- Menu -->

        <%- include('../../partial/side-bar.ejs'); -%>
          <!-- / Menu -->

          <!-- Layout container -->
          <div class="layout-page">
            <!-- Navbar -->

            <%- include('../../partial/nav'); -%>

              <!-- / Navbar -->

              <!-- Content wrapper -->
              <div class="container-xxl flex-grow-1 container-p-y">
                <h4 class="fw-bold py-3 mb-4"><span class="text-muted fw-light">
                    <%= module %> /
                  </span>
                  <%= heading %>
                </h4>
                <div class="row">
                  <!-- Basic Layout -->
                  <div class="col-xxl-8">

                    <div class="card md-4">
                      <h5 class="card-header">Dạnh sách sản phẩm</h5>

                      <div class="table-responsive text-nowrap">

                        <table class="table table-striped">
                          <thead>
                            <tr>
                              <th>Mã SP</th>
                              <th>Tên SP</th>
                              <th>SL</th>
                              <th>Giá </th>
                              <th>Thành tiền</th>
                              <th>Hành động</th>
                            </tr>
                          </thead>
                          <tbody class="table-border-bottom-0">

                          </tbody>
                        </table>
                      </div>
                    </div>
                  </div>
                  <!-- Basic with Icons -->
                  <div class="col-xxl-4">
                    <div class="card mb-4">
                      <div class="card-body">
                        <div class="row mb-3">
                          <label class="col-sm-2 col-form-label" for="basic-icon-default-fullname">SP</label>
                          <div class="col-sm-10">
                            <div class="input-group input-group-merge pb-3">
                              <input type="text" class="form-control" id="search_product"
                                placeholder="Tiềm kiếm sản phẩm" aria-label=""
                                aria-describedby="basic-icon-default-fullname2">
                            </div>
                            <span style=" position: absolute;
                            left: 80px;
                            top: 20%;
                            z-index: 1000;
                            width: 280px; background-color: #dcdfe1;" id="search_result"></span>
                          </div>
                        </div>

                        
                          <div class="row mb-3">
                            <label class="col-sm-2 col-form-label" for="basic-icon-default-fullname">Kho</label>
                            <div class="col-sm-10">
                              <select class="form-select" id="warehouse">

                                <% warehouse.forEach( function (element) { %>
                                  <option value="<%= element._id %>">
                                    <%= element.name %>
                                  </option>
                                  <% }) %>
                              </select>
                            </div>
                          </div>
                          <div class="row mb-3">
                            <label class="col-sm-2 col-form-label" for="basic-icon-default-fullname">Ngày</label>
                            <div class="col-sm-10">
                              <input class="form-control" type="datetime-local" id="theDate">
                            </div>
                          </div>
                          <div class="row mb-3">
                            <label class="col-sm-2 col-form-label" for="basic-icon-default-company">Ghi chú</label>
                            <div class="col-sm-10">
                              <textarea class="form-control" id="note" rows="3"></textarea>
                            </div>
                          </div>

                      

                      </div>
                    </div>
                    <div class="card mb-4">
                      <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">Thông tin thanh toán</h5>
                      </div>
                      <div class="card-body">

                        <div class="mb-3">
                          <label class="form-label" for="tien_hang">Tiền hàng</label>
                          <input type="text" value="" onkeyup="return thanh_toan()" class="form-control" id="tien_hang"
                            placeholder="" disabled>
                        </div>

                        <div class="mb-3">
                          <label class="form-label" for="tong_cong">Tổng cộng</label>
                          <input readonly type="text" class="form-control" id="tong_cong" placeholder="">
                        </div>
                        <div class="mb-3">
                          <label class="form-label" for="thanh_toan">Thanh toán</label>
                          <div class="input-group input-group-merge">
                            <input value="" type="text" id="thanh_toan" class="form-control" placeholder=""
                              aria-label="john.doe" aria-describedby="thanh_toan">
                          </div>
                        </div>
                        <div class="mb-3">
                          <label class="form-label" for="cong_no">Công nợ</label>
                          <div class="input-group input-group-merge">
                            <input readonly type="text" id="cong_no" class="form-control" placeholder=""
                              aria-label="john.doe" aria-describedby="cong_no">
                          </div>
                        </div>
                        <button type="submit" onclick=" getProduct(this)" class="btn btn-primary">Lưu</button>
                        <button type="submit" onclick=" getProduct(this)" class="btn btn-primary">Lưu và xem</button>

                      </div>
                    </div>
                  </div>
                </div>

              </div>
          </div>

          <!-- Content wrapper -->
      </div>
      <!-- / Layout page -->
    </div>

    <!-- Overlay -->
    <div class="layout-overlay layout-menu-toggle"></div>
    </div>

    <%- include('../../partial/script.ejs'); -%>

      <script>
        var now = new Date();
        now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
        now.setMilliseconds(null)
        now.setSeconds(null)

        document.getElementById('theDate').value = now.toISOString().slice(0, -1);
        $("input[data-type='currency']").on({
          keyup: function () {
            formatCurrency($(this));
          },
          blur: function () {
            formatCurrency($(this), "blur");
          }
        });

        $("button[type='submit']").click(function () {
          $("input[data-type='currency']").each(function (i, v) {
            var val = $(this).val();

            var a = val.replace(',', '');
            $(this).val(a);
            console.log($(this).val());
          })
        });

        function formatNumber(n) {
          // format number 1000000 to 1,234,567
          return n.replace(/\D/g, "").replace(/\B(?=(\d{3})+(?!\d))/g, ",")
        }


        function formatCurrency(input, blur) {
          // appends $ to value, validates decimal side
          // and puts cursor back in right position.

          // get input value
          var input_val = input.val();

          // don't validate empty input
          if (input_val === "") { return; }

          // original length
          var original_len = input_val.length;

          // initial caret position 
          var caret_pos = input.prop("selectionStart");

          // check for decimal
          if (input_val.indexOf(".") >= 0) {

            // get position of first decimal
            // this prevents multiple decimals from
            // being entered
            var decimal_pos = input_val.indexOf(".");

            // split number by decimal point
            var left_side = input_val.substring(0, decimal_pos);
            var right_side = input_val.substring(decimal_pos);

            // add commas to left side of number
            left_side = formatNumber(left_side);

            // validate right side
            right_side = formatNumber(right_side);

            // On blur make sure 2 numbers after decimal
            if (blur === "blur") {
              right_side += "00";
            }

            // Limit decimal to only 2 digits
            right_side = right_side.substring(0, 2);

            // join number by .
            input_val = left_side + "." + right_side;

          } else {
            // no decimal entered
            // add commas to number
            // remove all non-digits
            input_val = formatNumber(input_val);
            input_val = input_val;

            // // final formatting
            // if (blur === "blur") {
            //     input_val += ".00";
            // }
          }

          // send updated string to input
          input.val(input_val);

          // put caret back in the right position
          var updated_len = input_val.length;
          caret_pos = updated_len - original_len + caret_pos;
          input[0].setSelectionRange(caret_pos, caret_pos);
        }

      </script>

      <script>
        function load_data(query = '', product_result) {
          if (query == '') {
            $('#search_result').html('')
            return
          }
          if (product_result == 'undefined') {
            product_result = [];
          }
          $.ajax({
            type: "POST",
            url: "/san-pham/tim-kiem",
            data: {
              product: query,
              product_result: product_result
            },
            success: function (responseData) {
              var html = '<ul id="a" class="list-group" style="margin-bottom:20px">';

              if (responseData.length > 0) {
                responseData.forEach(element => {
                  html += '<a href="#" data-id="' + element.code + '" class="list-group-item list-group-item-action" onclick="get_text(this)">' + element.name + '</a>';
                });
              }
              else {
                html += '<a href="#" class="list-group-item list-group-item-action disabled">Không tìm thấy</a>';
              }

              html += '</ul>';
              $('#search_result').html(html);
            }
          });

        }
        var search_element = document.getElementById("search_product");

        search_element.onkeyup = function () {

          var product_result = [];
          var query = search_element.value;
          $('tbody tr').each(function (index, element) {
            var product = $(element).data('id')
            product_result.push(product)
          });

          load_data(query, product_result);

        };

        search_element.onfocus = function () {
          var product_result = [];
          var query = search_element.value;
          $('tbody tr').each(function (index, element) {
            var product = $(element).data('id')
            product_result.push(product)
          });

          load_data(query, product_result);

        };

        function get_text(e) {
          $('#search_result').html('');

          var code = $(e).data('id');

          fetch('/san-pham/search/' + code).then((res) => { return res.json() }).then((resData) => {

            var html = '<tr id="tr-' + resData.code + '" data-id="' + resData.code + '">'
            html += '<td>' + resData.code + '</td>';
            html += '<td>' + resData.name + '</td>';
            html += '<td> <input min="1" id="quantity-' + resData.code + '" value="0" onchange="changeSL(this)" data-id="' + resData.code + '" type="number" class="form-control" >' + '</td>';
            html += '<td> <input onchange="changePrice(this)" id="price-' + resData.code + '" data-id="' + resData.code + '" type="number" class="form-control" value="' + resData.price_in + '" >' + '</td>';
            html += '<td> <input id="' + resData.code + '-total" readonly type="number" class="form-control" value="0" >' + '</td>';
            html += '<td><button data-id="' + resData.code + '" onclick="deletePrduct(this)" type="submit" class="btn btn-primary">Xoá</button></td>';

            html += '</tr>';
            $('tbody').append(html);
          }).catch()

        }
        function deletePrduct(e) {

          var id = $(e).data('id');
          $('#tr-' + id).remove();
          tien_hang();
          tong_cong();
          thanh_toan();
          cong_no();
        }


        function changeSL(e) {
          tien_hang();
          tong_cong();
          thanh_toan();
          cong_no();
          var sl = $(e).val();
          var id = $(e).data('id');
          var price = $('#price-' + id).val();
          $('#' + id + '-total').val(sl * price);
        }
        function changePrice(e) {

          var price = $(e).val();
          var id = $(e).data('id');

          var sl = $('#quantity-' + id).val();

          $('#' + id + '-total').val(sl * price);
        }

        function tien_hang() {
          var total = 0;
          $('tbody tr').each(function (index, element) {
            var product = $(element).data('id')

            var quantity = $('#quantity-' + product).val();
            var price = $('#price-' + product).val();

            total += quantity * price;

          });
          $('#tien_hang').val(total)
        }


        function tong_cong() {

          var tien_hang = $('#tien_hang').val();
          $('#tong_cong').val(tien_hang);

        }

        function cong_no() {
          var tong_cong = $('#tong_cong').val();
          var thanh_toan = $('#thanh_toan').val();
          if (!thanh_toan) {
            $('#cong_no').val(tong_cong);
          }
          else if (thanh_toan - tong_cong >= 0) {
            $('#cong_no').val(0)
          } else {
            $('#cong_no').val(Math.abs(thanh_toan - tong_cong));

          }


        }
        $('#thanh_toan').keyup(function () {
          cong_no()
        })

        function thanh_toan() {
          cong_no()
        }

        function a(){
          window.location.href = "/nhap-hang/them"
        }
        function getProduct(e) {
          var date = $('#theDate').val();
          var note = $('#note').val();
          var tien_hang = $('#tien_hang').val();
          var tong_cong = $('#tong_cong').val();
          var thanh_toan = $('#thanh_toan').val();
          var cong_no = $('#cong_no').val();
          var warehouse = $('#warehouse').val();
          var sp = [];
          $('tbody tr').each(function (index, element) {
            var product = $(element).data('id')
            var quantity = $('#quantity-' + product).val();
            var price = $('#price-' + product).val();
            var a = {
              quantity: quantity,
              price: price,
              product: product
            }
            sp.push(a)

          });
          $.ajax({
            url: "/nhap-hang/them",
            type: "POST",
            data: {
              product: sp,
              date: date,
              note: note,
              tien_hang: tien_hang,
              thanh_toan: thanh_toan,
              cong_no: cong_no,
              tong_cong: tong_cong,
              kho_hang: warehouse,
            },
            success : function(res){
              if (res.status == 200) {
                $.notify("Lập phiếu thành công", "success");
                setInterval(a,2000);
               /// window.location.href = "/nhap-hang/them"
              }
            }
          });

        }
        function save_and_view() {

        }
      </script>
  </body>

  </html>